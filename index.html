<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Thu Internet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 8px; }
        ::-webkit-scrollbar-thumb:hover { background: #4f46e5; }
    </style>
</head>
<body class="bg-indigo-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-3xl shadow-2xl p-6 md:p-10 space-y-8 border border-indigo-100">
        
        <!-- Header -->
        <header class="text-center space-y-1">
            <h1 class="text-4xl font-extrabold text-indigo-700 tracking-tight">PHIẾU THU INTERNET</h1>
            <p class="text-sm text-indigo-400">Quản lý thu chi và hạn dùng tự động</p>
        </header>

        <!-- Loading Spinner -->
        <div id="loader" class="text-center py-12">
            <svg class="animate-spin h-10 w-10 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-slate-500 font-semibold">Đang tải danh sách khách hàng...</p>
        </div>

        <div id="main-content" class="hidden space-y-8">
            
            <!-- Khối 1: Chọn khách hàng -->
            <div class="space-y-4 p-6 bg-indigo-50 rounded-2xl border border-indigo-200 shadow-inner">
                <label for="customer-select" class="block text-lg font-bold text-indigo-700">1. Chọn Khách Hàng</label>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-3 sm:space-y-0 sm:space-x-3">
                    <select id="customer-select" class="block w-full px-4 py-3 bg-white border border-indigo-300 rounded-xl shadow-md focus:outline-none focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 text-lg font-medium transition duration-150 ease-in-out">
                        <option value="">-- Vui lòng chọn khách hàng --</option>
                    </select>
                    <!-- Nút Thêm Khách Hàng Mới (Đã cố định kích thước) -->
                    <button id="add-customer-btn" title="Thêm khách hàng mới" class="flex-shrink-0 bg-indigo-500 hover:bg-indigo-600 text-white font-bold p-3 rounded-xl shadow-lg transition-all duration-200 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                </div>
                <p id="current-package" class="text-sm text-indigo-600 font-medium h-5 italic"></p>
            </div>

            <!-- Khối 2: Cập nhật thanh toán -->
            <div class="space-y-6 p-6 bg-slate-50 rounded-2xl shadow-lg border">
                 <h2 class="text-lg font-bold text-slate-700 border-b pb-3">2. Thông Tin Thanh Toán</h2>
                
                <div>
                    <label for="amount-paid" class="block text-md font-semibold text-slate-700 mb-1">Số tiền nộp</label>
                    <!-- ĐÃ THAY ĐỔI: type="tel" để bật bàn phím số trên điện thoại -->
                    <input type="tel" id="amount-paid" placeholder="Nhập số tiền (VD: 70.000)" class="mt-1 block w-full px-5 py-3 bg-yellow-50 border-2 border-amber-400 rounded-xl shadow-inner focus:outline-none focus:ring-4 focus:ring-amber-200 focus:border-amber-600 text-2xl font-extrabold text-amber-700 transition duration-150 ease-in-out placeholder-gray-400">
                </div>
                
                <div>
                    <label class="block text-md font-semibold text-slate-700 mb-1">Hạn dùng mới (dự kiến)</label>
                    <div id="new-expiry-date" class="mt-1 flex flex-col md:flex-row items-center justify-between p-4 bg-emerald-100 border-2 border-emerald-300 rounded-xl text-emerald-800 font-extrabold text-xl md:text-2xl">
                        <span class="text-center">Chưa tính</span>
                        <span id="months-added" class="text-sm font-medium bg-emerald-200 text-emerald-900 px-3 py-1 rounded-full mt-2 md:mt-0"></span>
                    </div>
                </div>
                
                 <div>
                     <label for="notes" class="block text-md font-semibold text-slate-700 mb-1">Ghi chú</label>
                     <input type="text" id="notes" placeholder="Ghi chú về giao dịch (nếu có)" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
                 </div>
            </div>

            <!-- Submit Button -->
            <button id="submit-payment" disabled class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 disabled:from-slate-400 disabled:to-slate-500 text-white font-extrabold py-4 rounded-xl shadow-lg text-xl transition-all duration-300 hover:shadow-xl">
                Xác Nhận Nộp Tiền
            </button>
            
            <!-- Khối 3: Lịch sử gần nhất (Tham Khảo) -->
            <div id="history-block" class="space-y-4 p-6 bg-white rounded-2xl shadow-lg border border-slate-200 text-slate-600 hidden">
                <h2 class="text-lg font-bold text-indigo-700 border-b pb-3">3. Thông Tin Khách Hàng</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <span class="font-semibold text-slate-800 block text-sm">Hạn dùng gần nhất:</span>
                        <p id="history-expiry" class="text-2xl font-extrabold text-red-600 leading-tight"></p>
                    </div>
                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <span class="font-semibold text-slate-800 block text-sm">Ngày nộp (lần trước):</span>
                        <p id="history-payment-date" class="text-base font-semibold"></p>
                    </div>
                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <span class="font-semibold text-slate-800 block text-sm">Số tiền (lần trước):</span>
                        <p id="history-amount" class="text-lg font-bold text-indigo-600"></p>
                    </div>
                     <div class="p-3 bg-indigo-50 rounded-lg">
                         <span class="font-semibold text-slate-800 block text-sm">Giá Gói 12 tháng (Promo):</span>
                         <p id="history-promo-price" class="text-lg font-bold text-purple-600"></p>
                     </div>
                    <div class="sm:col-span-2 p-3 bg-indigo-50 rounded-lg">
                        <span class="font-semibold text-slate-800 block text-sm">Ghi chú:</span>
                        <p id="history-notes" class="italic text-slate-500"></p>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Modal Thêm Khách Hàng Mới -->
    <div id="add-customer-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-40 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 w-full max-w-lg space-y-6 relative transform scale-100 opacity-100 transition-all duration-300 ease-in-out">
            <h2 class="text-2xl font-bold text-indigo-700 border-b pb-3">Thêm Khách Hàng Mới</h2>
            <form id="new-customer-form" class="space-y-4">
                <input type="text" id="new-customer-name" required placeholder="Tên khách hàng *" class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                <!-- ĐÃ THAY ĐỔI: type="tel" -->
                <input type="tel" id="new-package-price" required placeholder="Giá 1 tháng (VD: 70.000) *" class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                <!-- ĐÃ THAY ĐỔI: type="tel" -->
                <input type="tel" id="new-promo-price" required placeholder="Giá 12 tháng (VD: 800.000) *" class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                <!-- ĐÃ THAY ĐỔI: type="tel" -->
                <input type="tel" id="new-initial-payment" required placeholder="Số tiền nộp ban đầu *" class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                <div>
                    <label for="new-expiry" class="block text-sm font-medium text-gray-700">Hạn sử dụng ban đầu (Ngày cuối tháng) *</label>
                    <input type="date" id="new-expiry" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                </div>
                <input type="text" id="new-notes" placeholder="Ghi chú (nếu có)" class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-add-customer" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors font-medium">Hủy</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors font-medium shadow-md">Tạo Khách Hàng</button>
                </div>
            </form>
             <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-indigo-600 transition-colors">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
    
    <!-- Notification Toast -->
    <div id="notification" class="fixed top-5 right-5 max-w-sm bg-green-500 text-white p-4 rounded-xl shadow-xl opacity-0 transform translate-y-10 transition-all duration-300 flex items-start space-x-4 z-50">
        <div id="notification-content" class="flex-grow"></div>
        <button id="notification-close-btn" class="flex-shrink-0">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // !!! QUAN TRỌNG: Dán URL Web App của Google Apps Script của bạn vào đây
    // URL này dùng để giao tiếp với Google Sheet để lưu/tải dữ liệu.
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPcDEwWoyxHrQlsKpePfCS6gAzJ1iFIn8fPBiDuV-ybJnQpKgp5K6Y0wkeZmipb5gc/exec';

    const loader = document.getElementById('loader');
    const mainContent = document.getElementById('main-content');
    const customerSelect = document.getElementById('customer-select');
    const currentPackage = document.getElementById('current-package');
    const amountPaidInput = document.getElementById('amount-paid');
    const newExpiryDateDiv = document.getElementById('new-expiry-date').querySelector('span:first-child');
    const monthsAddedSpan = document.getElementById('months-added');
    const notesInput = document.getElementById('notes');
    const historyBlock = document.getElementById('history-block');
    const submitBtn = document.getElementById('submit-payment');
    const notification = document.getElementById('notification');
    const notificationContent = document.getElementById('notification-content');
    const notificationCloseBtn = document.getElementById('notification-close-btn');
    const addCustomerBtn = document.getElementById('add-customer-btn');
    const modal = document.getElementById('add-customer-modal');
    const newCustomerForm = document.getElementById('new-customer-form');
    const cancelAddCustomerBtn = document.getElementById('cancel-add-customer');
    const modalCloseBtn = document.getElementById('modal-close-btn');

    let customersData = [];
    let selectedCustomer = null;
    let notificationTimer = null;

    // --- UTILITY FUNCTIONS ---
    const formatCurrency = (num) => num ? num.toLocaleString('vi-VN') + ' vnđ' : '0 vnđ';
    const parseCurrency = (str) => parseInt(String(str).replace(/[^0-9]/g, ''), 10) || 0;
    
    const formatDate = (dateStr, includeTime = false) => {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        if (isNaN(date)) return 'N/A';

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        if (includeTime) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes} ${day}/${month}/${year}`;
        }
        return `${day}/${month}/${year}`;
    };

    const hideNotification = () => {
        notification.classList.remove('opacity-100', 'translate-y-0');
        notification.classList.add('opacity-0', 'translate-y-10');
        if (notificationTimer) clearTimeout(notificationTimer);
    };

    const showNotification = (htmlContent, isError = false) => {
        if (notificationTimer) clearTimeout(notificationTimer);
        notificationContent.innerHTML = htmlContent;
        notification.classList.remove('bg-green-500', 'bg-red-500', 'opacity-0', 'translate-y-10');
        notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500', 'opacity-100', 'translate-y-0');
        
        // Thời gian hiển thị thông báo: 5 giây cho lỗi, 10 giây cho thành công
        if (isError) {
            notificationTimer = setTimeout(hideNotification, 5000); // 5 giây cho lỗi
        } else {
            notificationTimer = setTimeout(hideNotification, 10000); // 10 giây cho thành công
        }
    };

    const setLoadingState = (isLoading, form = 'payment') => {
        if (form === 'payment') {
            submitBtn.disabled = isLoading;
            submitBtn.textContent = isLoading ? 'Đang xử lý...' : 'Xác Nhận Nộp Tiền';
        } else {
            const createBtn = newCustomerForm.querySelector('button[type="submit"]');
            createBtn.disabled = isLoading;
            createBtn.textContent = isLoading ? 'Đang tạo...' : 'Tạo Khách Hàng';
        }
    };
    
    const resetUI = () => {
        selectedCustomer = null;
        historyBlock.classList.add('hidden');
        currentPackage.textContent = '';
        submitBtn.disabled = true;
        amountPaidInput.value = '';
        notesInput.value = '';
        newExpiryDateDiv.textContent = 'Chưa tính';
        monthsAddedSpan.textContent = '';
        customerSelect.value = '';
    };

    // --- DATA FETCHING & UI ---
    const fetchWithRetry = async (url, options = {}) => {
        let response;
        for (let i = 0; i < 3; i++) {
            try {
                response = await fetch(url, options);
                // For GET request, we expect response.ok. For no-cors POST, we just check if it executed without network error.
                if (options.method === 'POST' || response.ok) break;
            } catch (e) {
                console.warn(`Attempt ${i + 1} failed, retrying...`);
            }
            await new Promise(resolve => setTimeout(resolve, 2 ** i * 1000));
        }
        if (!response) throw new Error('Không thể kết nối đến Google Sheets/Script sau nhiều lần thử.');
        return response;
    };

    const fetchAndPopulateCustomers = async () => {
        loader.classList.remove('hidden');
        mainContent.classList.add('hidden');
        try {
            const response = await fetchWithRetry(`${SCRIPT_URL}?action=get_all`);
            customersData = await response.json();
            
            customerSelect.innerHTML = '<option value="">-- Vui lòng chọn khách hàng --</option>';
            customersData.forEach((customer, index) => {
                const option = document.createElement('option');
                option.value = index;
                const displayExpiry = formatDate(customer.hanDungMoi);
                option.textContent = `${customer.tenKH} (Hạn: ${displayExpiry})`;
                customerSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Lỗi khi tải danh sách khách hàng:', error);
            showNotification('<strong>Lỗi:</strong> Không thể tải danh sách khách hàng. Kiểm tra Apps Script URL.', true);
        } finally {
            loader.classList.add('hidden');
            mainContent.classList.remove('hidden');
        }
    };

    const handleCustomerSelect = () => {
        hideNotification();
        const selectedIndex = customerSelect.value;
        if (selectedIndex === "") {
            resetUI();
            return;
        }
        selectedCustomer = customersData[selectedIndex];
        updateUIForSelectedCustomer();
    };
    
    const updateUIForSelectedCustomer = () => {
        historyBlock.classList.remove('hidden');
        
        document.getElementById('history-expiry').textContent = formatDate(selectedCustomer.hanDungMoi);
        document.getElementById('history-payment-date').textContent = formatDate(selectedCustomer.ngayNop, true);
        document.getElementById('history-amount').textContent = formatCurrency(selectedCustomer.soTienNop);
        document.getElementById('history-promo-price').textContent = formatCurrency(selectedCustomer.giaKhuyenMai);
        document.getElementById('history-notes').textContent = selectedCustomer.ghiChu || 'Không có';
        
        currentPackage.textContent = `Gói cước: ${formatCurrency(selectedCustomer.gia1Thang)}/tháng. Giá 12 tháng: ${formatCurrency(selectedCustomer.giaKhuyenMai)}.`;
        
        notesInput.value = '';
        amountPaidInput.value = '';
        
        calculateNewExpiry();
        submitBtn.disabled = false;
    };
    
    // --- CALCULATIONS (ĐÃ CẬP NHẬT LOGIC NGÀY CUỐI THÁNG) ---
    const calculateNewExpiry = () => {
        if (!selectedCustomer) { 
            newExpiryDateDiv.textContent = 'Chưa tính'; monthsAddedSpan.textContent = ''; submitBtn.disabled = true; return;
        }
        const amountPaid = parseCurrency(amountPaidInput.value);
        
        if (amountPaid === 0) {
            newExpiryDateDiv.textContent = 'Chưa tính'; monthsAddedSpan.textContent = ''; submitBtn.disabled = true; return;
        }
        
        const { gia1Thang, giaKhuyenMai, hanDungMoi } = selectedCustomer;
        
        let monthsToAdd = 0;
        
        if (giaKhuyenMai > 0 && amountPaid === giaKhuyenMai) {
            monthsToAdd = 12;
        } else if (gia1Thang > 0) {
            monthsToAdd = Math.floor(amountPaid / gia1Thang);
        }

        if (monthsToAdd <= 0) {
            newExpiryDateDiv.textContent = 'Số tiền không đủ'; monthsAddedSpan.textContent = ''; submitBtn.disabled = true; return;
        }
        
        // Lấy ngày hết hạn cũ
        const expiryDateOld = new Date(hanDungMoi);

        // Tính ngày cuối cùng của tháng sau khi cộng thêm số tháng (monthsToAdd)
        // Bằng cách tạo một Date object với ngày là 0 (ngày cuối tháng trước đó)
        // Ta cần cộng 1 vào tháng hiện tại của ngày hết hạn cũ (vì hanDungMoi đang là ngày cuối tháng, 
        // tháng hết hạn cũ đã kết thúc) rồi mới cộng thêm số tháng mới.
        const finalMonth = expiryDateOld.getMonth() + 1 + monthsToAdd;
        const newDate = new Date(expiryDateOld.getFullYear(), finalMonth, 0); // Ngày 0 của tháng tiếp theo là ngày cuối của tháng hiện tại

        newExpiryDateDiv.textContent = formatDate(newDate);
        monthsAddedSpan.textContent = `+${monthsToAdd} tháng`;
        
        submitBtn.disabled = false;
    };

    // --- DATA SUBMISSION (ĐÃ CẬP NHẬT LOGIC NGÀY CUỐI THÁNG) ---
    const submitAction = async (payload) => {
        const isAdding = payload.action === 'add_customer';
        setLoadingState(true, isAdding ? 'add' : 'payment');
        try {
            // Sử dụng fetchWithRetry cho POST request (mode: no-cors không trả về status)
            await fetchWithRetry(SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const successMessage = isAdding
                ? `Đã tạo KH mới: <strong class="font-bold text-yellow-300">${payload.tenKH}</strong>. Hạn dùng đến <strong class="font-bold text-yellow-300">${formatDate(payload.hanDungMoi)}</strong>.`
                : `Đã nộp tiền cho <strong class="font-bold text-yellow-300">${payload.tenKH}</strong>, hạn dùng mới đến <strong class="font-bold text-yellow-300">${formatDate(payload.hanDungMoi)}</strong>.`;
            
            showNotification(successMessage);
            
            if (isAdding) {
                toggleModal(false);
                newCustomerForm.reset();
            }
            resetUI();
            await fetchAndPopulateCustomers(); // Refresh the list
        } catch (error) {
            console.error('Lỗi khi gửi dữ liệu:', error);
            showNotification('Có lỗi xảy ra khi gửi dữ liệu. Vui lòng kiểm tra kết nối và Apps Script.', true);
        } finally {
            setLoadingState(false, isAdding ? 'add' : 'payment');
        }
    };
    
    const submitPayment = () => {
        if (!selectedCustomer) { showNotification('Vui lòng chọn khách hàng.', true); return; }
        const amountPaid = parseCurrency(amountPaidInput.value);
        if (amountPaid <= 0) { showNotification('Vui lòng nhập số tiền hợp lệ.', true); return; }

        const { gia1Thang, giaKhuyenMai, hanDungMoi } = selectedCustomer;
        let monthsToAdd = 0;
        
        if (giaKhuyenMai > 0 && amountPaid === giaKhuyenMai) {
            monthsToAdd = 12;
        } else if (gia1Thang > 0) {
            monthsToAdd = Math.floor(amountPaid / gia1Thang);
        }

        if (monthsToAdd <= 0) {
            showNotification('Số tiền nộp không đủ cho 1 tháng.', true); 
            return;
        }
        
        // Lấy ngày hết hạn cũ
        const expiryDateOld = new Date(hanDungMoi);

        // Tính ngày cuối cùng của tháng sau khi cộng thêm số tháng
        const finalMonth = expiryDateOld.getMonth() + 1 + monthsToAdd;
        const newExpiry = new Date(expiryDateOld.getFullYear(), finalMonth, 0); // Ngày cuối tháng

        submitAction({
            action: 'submit_payment', tenKH: selectedCustomer.tenKH, soTienNop: amountPaid,
            hanDungMoi: newExpiry.toISOString(), gia1Thang: gia1Thang, soThang: monthsToAdd,
            giaKhuyenMai: giaKhuyenMai, ngayNop: new Date().toISOString(), ghiChu: notesInput.value || ''
        });
    };
    
    const addNewCustomer = (e) => {
        e.preventDefault();
        const name = document.getElementById('new-customer-name').value;
        const packagePrice = parseCurrency(document.getElementById('new-package-price').value);
        const promoPrice = parseCurrency(document.getElementById('new-promo-price').value);
        const initialPayment = parseCurrency(document.getElementById('new-initial-payment').value);
        const expiryDateStr = document.getElementById('new-expiry').value;
        
        if (!name || packagePrice <= 0 || initialPayment <= 0 || !expiryDateStr || promoPrice <= 0) {
            showNotification('Vui lòng điền đầy đủ thông tin bắt buộc và hợp lệ.', true); return;
        }

        let months = (promoPrice > 0 && initialPayment === promoPrice) ? 12 : Math.floor(initialPayment / packagePrice);
        
        // Tính ngày hết hạn ban đầu (lấy ngày cuối tháng dựa trên ngày đã chọn)
        const selectedExpiryDate = new Date(expiryDateStr);
        // Date(year, month + 1, 0) sẽ cho ngày cuối cùng của tháng được chỉ định bởi 'month'
        const initialExpiry = new Date(selectedExpiryDate.getFullYear(), selectedExpiryDate.getMonth() + 1, 0); 
        
        submitAction({
            action: 'add_customer', tenKH: name, soTienNop: initialPayment, hanDungMoi: initialExpiry.toISOString(),
            gia1Thang: packagePrice, soThang: months, giaKhuyenMai: promoPrice,
            ngayNop: new Date().toISOString(), ghiChu: document.getElementById('new-notes').value
        });
    };
    
    // --- MODAL HANDLING & EVENT LISTENERS ---
    const toggleModal = (show) => modal.classList.toggle('hidden', !show);
    
    customerSelect.addEventListener('change', handleCustomerSelect);

    // Xử lý nhập liệu số tiền nộp (chỉ cho phép nhập số, tự động thêm dấu phân cách)
    [amountPaidInput, ...newCustomerForm.querySelectorAll('input[id*="price"], input[id*="payment"]')].forEach(input => {
        input.addEventListener('input', (e) => {
            const rawValue = e.target.value;
            const numericValue = parseCurrency(rawValue); 
            e.target.value = numericValue > 0 ? numericValue.toLocaleString('vi-VN') : '';
            
            if (e.target.id === 'amount-paid') {
                calculateNewExpiry();
            }
        });
        input.addEventListener('focus', hideNotification);
    });

    submitBtn.addEventListener('click', submitPayment);
    addCustomerBtn.addEventListener('click', () => { hideNotification(); toggleModal(true); });
    notificationCloseBtn.addEventListener('click', hideNotification);
    cancelAddCustomerBtn.addEventListener('click', () => toggleModal(false));
    modalCloseBtn.addEventListener('click', () => toggleModal(false));
    modal.addEventListener('click', (e) => { if (e.target === modal) toggleModal(false); });
    newCustomerForm.addEventListener('submit', addNewCustomer);

    // Initial Load
    fetchAndPopulateCustomers();
});
</script>
</body>
</html>

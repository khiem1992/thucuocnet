<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra Cứu Hóa Đơn Master (GitHub v1.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background 0.3s; }
        .invoice-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-10">

    <div id="login-modal" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl text-center">
            <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">Yêu cầu truy cập</h2>
            <p class="text-slate-500 mb-6 text-sm">Nhập mật khẩu để tra cứu hóa đơn Master</p>
            <input type="password" id="api-key-input" class="w-full px-4 py-3 border border-slate-300 rounded-xl text-center text-lg focus:ring-2 focus:ring-indigo-500 outline-none mb-4" placeholder="••••••••">
            <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all">Vào hệ thống</button>
        </div>
    </div>

    <div id="main-content" class="hidden max-w-5xl mx-auto px-4 pt-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-900">Hóa Đơn Master</h1>
            <button onclick="logout()" class="text-sm text-red-500 font-medium hover:underline">Đăng xuất</button>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="text-[10px] font-bold uppercase text-slate-400 mb-1 block">Tìm kiếm</label>
                <input type="text" id="searchBox" oninput="filterData()" placeholder="Số HĐ, Phòng, Tên khách..." class="w-full bg-slate-50 px-4 py-2 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
                <label class="text-[10px] font-bold uppercase text-slate-400 mb-1 block">Từ ngày</label>
                <input type="date" id="dateFrom" onchange="filterData()" class="w-full bg-slate-50 px-4 py-2 rounded-lg outline-none">
            </div>
            <div>
                <label class="text-[10px] font-bold uppercase text-slate-400 mb-1 block">Đến ngày</label>
                <input type="date" id="dateTo" onchange="filterData()" class="w-full bg-slate-50 px-4 py-2 rounded-lg outline-none">
            </div>
        </div>

        <div id="loading" class="text-center py-20 flex flex-col items-center">
            <div class="w-10 h-10 border-4 border-slate-200 border-t-indigo-600 rounded-full loading-spin mb-4"></div>
            <p class="text-slate-400">Đang tải kho hóa đơn...</p>
        </div>
        <div id="invoiceList" class="space-y-4 hidden"></div>
        <div id="empty" class="hidden text-center py-20 text-slate-400">Không tìm thấy dữ liệu phù hợp.</div>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4 hidden" onclick="closeModal()">
        <div class="bg-white w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden animate-in fade-in scale-95 duration-200" onclick="event.stopPropagation()">
            <div id="modalHeader" class="px-6 py-4 bg-indigo-600 text-white flex justify-between items-center">
                <h3 id="modalTitle" class="font-bold">Chi tiết</h3>
                <button onclick="closeModal()">✕</button>
            </div>
            <div id="modalBody" class="p-6 max-h-[75vh] overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbw38amG3ymES5MwBNdFvaYFPS7L72EL4oije0WRexZ8BcMfWg2bgfjccsdRqXbqvYR2/exec?'; // <--- QUAN TRỌNG
        let allData = [];
        let sessionKey = localStorage.getItem('master_api_key');

        window.onload = () => {
            if(sessionKey) {
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                fetchData();
            }
        };

        function handleLogin() {
            const key = document.getElementById('api-key-input').value;
            if(!key) return;
            sessionKey = key;
            localStorage.setItem('master_api_key', key);
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            fetchData();
        }

        async function fetchData() {
            try {
                const response = await fetch(`${GAS_URL}?key=${sessionKey}&t=${Date.now()}`);
                const res = await response.json();
                if(res.status === 'success') {
                    allData = res.data;
                    filterData();
                } else {
                    alert(res.message);
                    logout();
                }
            } catch (e) {
                alert("Lỗi kết nối API!");
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function filterData() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;

            const filtered = allData.filter(row => {
                const textMatch = row[0].toString().includes(search) || row[1].toLowerCase().includes(search) || row[7].toLowerCase().includes(search);
                const dateObj = parseDate(row[2]);
                let dateMatch = true;
                if(from) dateMatch = dateMatch && (dateObj >= new Date(from));
                if(to) {
                    const toDate = new Date(to); toDate.setHours(23,59,59);
                    dateMatch = dateMatch && (dateObj <= toDate);
                }
                return textMatch && dateMatch;
            }).reverse(); // Mới nhất lên đầu

            renderList(filtered);
        }

        function renderList(data) {
            const container = document.getElementById('invoiceList');
            const empty = document.getElementById('empty');
            container.innerHTML = '';
            
            if(data.length === 0) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            container.classList.remove('hidden');
            empty.classList.add('hidden');

            data.forEach(row => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-200 invoice-card cursor-pointer flex justify-between items-center transition-all";
                div.onclick = () => showDetail(row);
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center font-bold text-sm">#${row[0]}</div>
                        <div>
                            <div class="font-bold text-slate-800">${row[1]} <span class="text-slate-400 font-normal">|</span> ${row[7] || 'Khách lẻ'}</div>
                            <div class="text-[10px] text-slate-500 uppercase font-semibold">${formatDate(row[2])}</div>
                        </div>
                    </div>
                    <div class="text-green-600 font-extrabold">${new Intl.NumberFormat('vi-VN').format(row[4])}</div>
                `;
                container.appendChild(div);
            });
        }

        function showDetail(row) {
            document.getElementById('modalTitle').innerText = `Hóa đơn #${row[0]} - ${row[1]}`;
            const body = document.getElementById('modalBody');
            
            const parseSub = (str, label) => {
                if(!str) return `<p class="text-slate-400 text-xs italic">Không có ${label}</p>`;
                return str.split(';').map(item => {
                    const p = item.split('*');
                    return `<div class="flex justify-between py-1 border-b border-slate-50 text-xs"><span>${p[0]}</span><span class="font-bold text-slate-600">${new Intl.NumberFormat('vi-VN').format(p[p.length-1])}</span></div>`;
                }).join('');
            };

            body.innerHTML = `
                <div class="bg-slate-50 rounded-2xl p-4 mb-6 grid grid-cols-2 gap-4 text-xs">
                    <div><p class="text-slate-400 uppercase font-bold text-[9px]">Vào lúc</p><p class="font-bold">${formatDate(row[2])}</p></div>
                    <div><p class="text-slate-400 uppercase font-bold text-[9px]">Ra lúc</p><p class="font-bold">${formatDate(row[3])}</p></div>
                    <div class="col-span-2 pt-2 border-t border-slate-200 flex justify-between items-center text-sm">
                        <span class="font-bold text-slate-500 uppercase text-[10px]">Tổng thanh toán</span>
                        <span class="text-xl font-black text-indigo-600">${new Intl.NumberFormat('vi-VN').format(row[4])} VNĐ</span>
                    </div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-[10px] font-black uppercase text-indigo-500 tracking-widest">Chi tiết dịch vụ</h4>
                    <div>${parseSub(row[5], 'thực đơn')}</div>
                    <h4 class="text-[10px] font-black uppercase text-blue-500 tracking-widest pt-2">Nhân viên phục vụ</h4>
                    <div>${parseSub(row[6], 'nhân viên')}</div>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function logout() { localStorage.removeItem('master_api_key'); location.reload(); }
        
        function parseDate(v) { return typeof v === 'number' ? new Date((v - 25569) * 86400000) : new Date(v); }
        function formatDate(v) { 
            const d = parseDate(v); 
            return d.toLocaleString('vi-VN', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});
        }
    </script>
</body>
</html>
